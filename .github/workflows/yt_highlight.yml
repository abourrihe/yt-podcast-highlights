name: YouTube Highlight (self-hosted, Windows)

on:
  workflow_dispatch:
    inputs:
      videoId:
        description: "YouTube Video ID (e.g., dQw4w9WgXcQ)"
        required: true
        type: string
      browser:
        description: "Browser to read cookies from"
        required: true
        default: "chrome"
        type: choice
        options: [chrome, edge]
      profile:
        description: 'Browser profile name (e.g., "Default", "Profile 1")'
        required: false
        default: "Default"
        type: string
      format:
        description: "yt-dlp format (leave default unless needed)"
        required: false
        default: 'bv*[ext=mp4]+ba[ext=m4a]/b[ext=mp4]/bv*+ba/b'
        type: string

jobs:
  highlight:
    runs-on: self-hosted

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # Allow PowerShell scripts for this user (so setup-python can run its scripts)
      - name: Allow PowerShell scripts
        shell: powershell
        run: |
          Set-ExecutionPolicy -Scope CurrentUser -ExecutionPolicy RemoteSigned -Force

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install yt-dlp
        shell: powershell
        run: |
          python -m pip install --upgrade pip
          pip install --upgrade yt-dlp

      # (Optional) sanity check ffmpeg; warns but does not fail
      - name: Check ffmpeg availability
        shell: powershell
        run: |
          if (Get-Command ffmpeg -ErrorAction SilentlyContinue) {
            ffmpeg -version | Select-Object -First 1
          } else {
            Write-Host "WARNING: ffmpeg not found on PATH. If merge is needed, install ffmpeg or add it to PATH."
          }

      - name: Download source video (live cookies)
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"
          $VIDEO_ID='${{ inputs.videoId }}'
          $BROWSER='${{ inputs.browser }}'
          $PROFILE='${{ inputs.profile }}'
          $FMT='${{ inputs.format }}'

          Write-Host "Using browser=$BROWSER, profile=$PROFILE"
          $CFB="$($BROWSER.ToLower()):profile=$PROFILE"

          yt-dlp --cookies-from-browser "$CFB" `
                 --extractor-args "youtube:player_client=android" `
                 -o "input.%(ext)s" -f "$FMT" `
                 "https://www.youtube.com/watch?v=$VIDEO_ID"

          Write-Host "Downloaded files:"
          Get-ChildItem -Force | Format-Table -AutoSize

      - name: Upload source artifact
        uses: actions/upload-artifact@v4
        with:
          name: source-video
          path: |
            input*.mp4
            input*.mkv
            input*.webm
          if-no-files-found: warn
